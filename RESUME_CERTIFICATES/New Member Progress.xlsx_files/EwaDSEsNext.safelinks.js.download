'use strict';(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[64],{1477:function(r,F,a){a.r(F);var c=a(105),b=a(187),e=a(4);r=a(0);var f=a(15),d=a(85);class h{constructor(G,D,E,N,M,L){this.PolicyCookie=this.WebAffinitizedUrl=this.IsSafeLinksEnabled=null;this.PolicyCookieTTL=0;this.WasServiceDown=!1;this.AffinitizedUrl=null;this.IsSafeLinksEnabled=G;this.WebAffinitizedUrl=D;this.PolicyCookie=E;this.PolicyCookieTTL=N;this.WasServiceDown=M;this.AffinitizedUrl=L}}Object(r.a)(h,
"SafeLinksData",null,[]);class l{constructor(G,D){this.NBc=G;this.stopwatch=D}}Object(r.a)(l,"SafeLinksGetUrlReputationRequestData",null,[]);var k=a(39),t=a(40);class n{constructor(G,D,E,N){this.mb=G;this.ph=D;this.yxg=E;n.rh=N}OBa(G,D,E){try{var N=null;n.rh&&(N=n.rh.Gc("WebServiceCall","SafeLinksGetUrlReputation"));const M=new l(D,N);N={};N.AffinitizedUrl=G;N.TargetUrl=D;N.PolicyCookie=E;const L=k.c(N);this.ph.Jm(this.yxg,2,L,null,!1,2,Object(d.a)(this,this.KUi,"onGetUrlReputationSuccessCallback"),
Object(d.a)(this,this.JUi,"onGetUrlReputationFailureCallback"),M,void 0,void 0,3E3,3E3,"36");return!0}catch(M){f.ULS.sendTraceTag(588788033,378,10,M.message)}return!1}KUi(G){let D="OnGetUrlReputationSuccessCallback: ",E=10;const N=G.data.state;try{const M=k.b(G.data.de).reputationResults[0],L=M.navigateUrl.length,aa=N.NBc.length,V=M.navigateUrl===N.NBc;M.navigateUrl&&0<M.navigateUrl.length&&(N.NBc=M.navigateUrl);D+=String.format("HttpStatus {0}, verdict {1}, clickedUrlLength = {2} navigateUrlLength {3}, navigateUrlSameAsClickedUrl {4}",
G.data.httpStatus,M.verdict,aa.toString(),L.toString(),V.toString());E=50}catch(M){D+=String.format("Exception {0}",M.message)}this.G$e(N,D,E)}JUi(G){let D="OnGetUrlReputationFailureCallback: ";const E=G.data.state;try{D+=String.format("HttpStatus {0}",G.data.httpStatus)}catch(N){D+=String.format("Exception {0}",N.message)}this.G$e(E,D,10)}G$e(G,D,E){G.stopwatch&&(G.stopwatch.stop(),G.stopwatch=null);f.ULS.sendTraceTag(588788034,378,E,D);t.a.gf(G.NBc,void 0,"noopener,noreferrer","SafeLinksNav")}}
n.rh=null;Object(r.a)(n,"SafeLinksNavigationHelper",null,[]);var z;(function(G){G[G.enabledByPolicy=0]="enabledByPolicy";G[G.disabledByPolicy=1]="disabledByPolicy";G[G.disabled_GetPolicyFailure=2]="disabled_GetPolicyFailure";G[G.disabled_PendingGetPolicyRequest=3]="disabled_PendingGetPolicyRequest"})(z||(z={}));Object(r.b)("SafeLinksNavigationState",z);var w=a(99),m=a(137),u=a(798),y=a(255),v=a(241),C=a(699),x=a(27),B=a(174),H=a(194);class I{constructor(G,D,E,N=!1,M=null,L=null){this.SDa=this.RDa=
0;this.$Ab=this.gUb=!1;this.$qa=null;this.GWa=!0;this.JXb=null;f.ULS.sendTraceTag(26019598,378,100,"Initializing SafeLinksManager.");this.mb=G;this.ph=D;this.vpa=E;I.rh=L;this.IGg=N?this.mb.Wa("SafeLinksHandlerWebServiceBase"):this.mb.Wa("WebServiceBase");this.pGg=this.mb.Wa("SafeLinksHashedUserId");this.r7j=this.mb.Wa("SafeLinksWorkloadIdHeaderValue");this.EVb=this.mb.vd("SafeLinksMaxGetPolicyBootRetries",2);this.FVb=this.mb.vd("SafeLinksMaxGetPolicyOnLinkClickRetries",1);this.LUb=this.isSafeLinksEnabledForUser();
this.KUb=this.Tti();f.ULS.sendTraceTag(26019599,378,50,"SafeLinksManager _isEnabledForUser={0}, _isEnabledForBrowser={1}",this.LUb,this.KUb);if(this.LUb&&this.KUb){D=(G=this.g4a())?G.IsSafeLinksEnabled.toLowerCase():"";E=this.csd();f.ULS.sendTraceTag(36231312,378,50,"Cached values for IsSafeLinksEnabled: {0}, IsPolicyCookieExpired: {1}.",D,E);var aa=!G||"unknown"===D||G.WasServiceDown||E,V=m.a.Pr();V&&(V.set("shouldGetSafeLinksDataFromServer",aa.toString()),V.set("isSafeLinksEnabledCacheValue",D.toString()));
M?(this.GWa=!1,M.execute(P=>{P.isFeatureEnabled("MsoUrlreputation",!0).then(ba=>{this.GWa=ba;V.set("isUserLicensedForSafeLinks",this.GWa.toString());w.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",V);this.GWa&&aa&&this.qdc(!0);return null})})):(w.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",V),aa&&this.qdc(!0))}}get appName(){return this.vpa}get CFc(){return this.IGg}get userId(){return this.pGg}get f0h(){const G=this.CFc?this.CFc+"/":"",D=new y.QueryStringBuilder("SafeLinksHandler.ashx");
D.Zi("app",this.appName);this.mb.pa("SafeLinksUseDebugHeader")&&D.Zi("action","debug");this.mb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&D.Zi("s2satpop","1");this.mb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&D.Zi("s2se03","1");return String.format("{0}{1}&{2}",G,D.toString(),e.AFrameworkApplication.vi)}get g6h(){const G=this.CFc?this.CFc+"/":"",D=new y.QueryStringBuilder("SafeLinksHandler.ashx");D.Zi("app",this.appName);
this.mb.pa("SafeLinksUseDebugHeader")&&D.Zi("action","debug");this.mb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&D.Zi("s2satpop","1");this.mb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",!1)&&D.Zi("s2saat","1");this.mb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&D.Zi("s2se03","1");D.Zi("slrt","GetUrlReputation");return String.format("{0}{1}&{2}",G,D.toString(),e.AFrameworkApplication.vi)}get JKi(){I.ESc||
(I.ESc=new n(this.mb,this.ph,this.g6h,I.rh));return I.ESc}OBa(G){if(!G)return f.ULS.sendTraceTag(593367827,378,10,"SafeLinksManager.TryNavigate: Null/Empty targetUrl"),!1;var D=this.hqi(G);f.ULS.sendTraceTag(594830615,378,50,"SafeLinksManager.TryNavigate: isSupportedHyperLinkType={0},_isEnabledForUser={1},_isEnabledForBrowser={2},_isUserLicensedForSafeLinks={3}",D,this.LUb,this.KUb,this.GWa);if(!(D&&this.LUb&&this.KUb&&this.GWa))return!1;D=0;const E=({state:D}=this.IHj()).returnValue;f.ULS.sendTraceTag(595079385,
378,50,"ShouldTryUsingSafeLinksService returned NavigationState={0}",z[D]);const N=m.a.Pr();N&&N.set("SafeLinksNavigationState",z[D]);w.Health.instance.recordKpiUsage("SafeLinksNavigations",0,"jpittsdirects",N);if(!E)return 2!==D&&3!==D||w.Health.instance.recordKpiFailure("SafeLinksNavigations",z[D],!1,!0,null),!1;f.ULS.sendTraceTag(26019601,378,50,"Using safelinks to navigate hyperlink");if(this.PHj())return this.csd()?!1:this.JKi.OBa(this.yOh(),G,this.a6e());if(!this.csd())return this.hhg(G),!0;
this.$qa=G;f.ULS.sendTraceTag(24462627,378,50,"Refreshing the cache as policy cookie expired.");this.$Ab=!1;this.qdc();return!0}hqi(G){G=G.toLowerCase();const D=this.mb.kw("SafeLinksUnsupportedProtocols");if(D)for(let E=0;E<D.length;E++)if(G.startsWith(D[E]))return!1;return!0}qdc(G=!1){var D=m.a.Pr();D&&D.set("isOnBootRequest",G.toString());w.Health.instance.recordKpiUsage("SafeLinksGetPolicySuccessfulRequest",1,"jpittsdirects",D);w.Health.instance.recordKpiUsage("SafeLinksGetPolicyFailedRequest",
0,"jpittsdirects",D);D=this.u5c("SafeLinksGetPolicy");this.ph.Jm(this.f0h,1,null,null,!0,2,Object(d.a)(this,this.F2h,"getSafeLinksDataFromServer_OnSuccessCallback"),Object(d.a)(this,this.E2h,"getSafeLinksDataFromServer_OnFailureCallback"),D,void 0,void 0,void 0,void 0,"23");this.$Ab=G;this.gUb=!0;G?this.RDa++:this.SDa++}F2h(G){let D=v.a.GLi,E="";try{this.gUb=this.$Ab=!1;var N=G.data.state;const ea=({stopwatch:N}=this.WAc(N)).returnValue,ra=Object.assign(new H.a,{durationMs:ea});w.Health.instance.recordKpiSuccess("SafeLinksGetPolicySuccessfulRequest",
ra);f.ULS.sendTraceTag(594830614,378,50,"GetSafeLinksDataFromServer_OnSuccessCallback: HttpStatus {0}, data length {1}, Duration {2}",G.data.httpStatus,G.data.de.length,ea);if(G.data.httpStatus!==v.a.IO)E="Unexpected httpStatus: "+G.data.httpStatus.toString();else{N=null;try{N=k.b(G.data.de)}catch(O){E="Exception:"+O.toString()+" deserializing response";return}if(N){var M=N.IsSafeLinksEnabled;if(void 0===M||null===M||0>=M.length)E="Invalid isSafeLinksEnabledString";else{f.ULS.sendTraceTag(594830613,
378,50,"Retrieved isSafeLinksEnabledString {0}",M);var L=I.PFd(M);if(void 0===N.WebAffinitizedUrl||null===N.WebAffinitizedUrl||0>=N.WebAffinitizedUrl.length)E="Invalid WebAffinitizedUrl";else if(void 0===N.PolicyCookie||null===N.PolicyCookie||0>=N.PolicyCookie.length)E="Invalid PolicyCookie";else if(void 0===N.PolicyCookieTTL||null===N.PolicyCookieTTL)E="Invalid PolicyCookieTTL";else{var aa=N.WebAffinitizedUrl,V=N.PolicyCookie,P=N.AffinitizedUrl,ba=new Date;ba.setMinutes(ba.getMinutes()+(5<N.PolicyCookieTTL?
N.PolicyCookieTTL-5:0));var Y=ba.getTime(),Z=new h(M,aa,V,Y,!1,P);this.$3f(Z);D=G.data.httpStatus;this.$qa&&(L?(this.hhg(this.$qa),this.SDa=this.RDa=0):(f.ULS.sendTraceTag(26019602,378,50,"SafeLinks is disabled by admin; Navigating without SafeLinks"),w.Health.instance.recordKpiFailure("SafeLinksNavigations","disabledByPolicy",!0,!0,null),t.a.FU(this.$qa)),this.$qa=null)}}}else E="Error when serializing response into SafeLinksData. SafeLinksData is null."}}catch(ea){E="GetSafeLinksDataFromServer_OnSuccessCallback: Exception:  "+
ea.toString()}finally{D!==v.a.IO&&this.F$e(D,E)}}E2h(G){this.gUb=!1;let D=500,E="";try{let N=G.data.state;const M=({stopwatch:N}=this.WAc(N)).returnValue,L=Object.assign(new H.a,{durationMs:M});D=G.data.httpStatus;w.Health.instance.recordKpiFailure("SafeLinksGetPolicyFailedRequest","HttpStatusCode_"+D.toString(),!1,!0,L);E="Request Failed, Status="+C.a[G.data.status]+" Duration: "+M}catch(N){E="GetSafeLinksDataFromServer_OnFailureCallback Exception: "+N.toString()}finally{this.F$e(D,E)}}F$e(G,D=""){try{if(f.ULS.sendTraceTag(594830612,
378,10,"HandleGetPolicyRequestError: HttpStatus {0}, Error {1}",G,D),this.RDa<this.EVb&&this.SDa<this.FVb)this.qdc(this.$Ab);else{this.$Ab=!1;f.ULS.sendTraceTag(24462656,378,10,"Exhausted all retries for SafeLinks GetPolicy call. OnBootRetries: {0}, OnClickRetries: {1}, HttpStatus: {2}, Error: {3}",this.RDa,this.SDa,G,D);D=null;const E=m.a.Pr();E&&(E.set("HttpStatus",G.toString()),D=Object.assign(new H.a,{extendedProperties:E}));w.Health.instance.recordKpiFailure("SafeLinksGetPolicy1","GetPolicyRequestError",
!1,!0,D);const N=new h("false","","",0,!0,"");this.$3f(N);this.$qa&&(f.ULS.sendTraceTag(26019603,378,50,"Error occurred during at-click GetPolicy call, NavigationState = {0}","disabled_GetPolicyFailure"),w.Health.instance.recordKpiFailure("SafeLinksNavigations","disabled_GetPolicyFailure",!1,!0,null),t.a.FU(this.$qa),this.$qa=null)}}catch(E){f.ULS.sendTraceTag(594830611,378,10,"HandleGetPolicyRequestError: Exception {0}",E.toString())}}hhg(G){const D=this.a6e(),E=this.T6h(),N={};N.Url=G;N.SafeLinksCookie=
D;N.CorrelationId=B.a.create().toString();N.WorkloadId=this.r7j;N.UserAgentInfo=x.a.wsa+"|"+this.appName;f.ULS.sendTraceTag(23900187,378,50,"Validating hyperlink with request correlation: {0}",N.CorrelationId);t.a.nsc(t.a.bX(4),E,N)}isSafeLinksEnabledForUser(){const G=this.mb.Wa("IsSafeLinksEnabledForUser");return G?I.PFd(G):!1}Tti(){const G=this.mb.kw("SafeLinksDisabledBrowsers");if(x.a.ZA){if(this.mb.Gp("SafeLinksForTeamsIsEnabled")&&this.mb.pa("SafeLinksForTeamsIsEnabled"))return!0;if(Array.contains(G,
"Electron"))return!1}else if(Array.contains(G,x.a.wsa))return!1;return"officecomhwa"===(this.mb.Wa(e.AFrameworkApplication.J7)||"").toLowerCase()?!1:!0}PHj(){return-1!==window.location.href.indexOf("&wd_slnh=1")||this.mb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksUseNavigationHelperForMobile",!1)&&x.a.Bba?!0:x.a.ZA}IHj(){let G;G=0;const D=this.g4a(),E=D?D.IsSafeLinksEnabled:"";if(""!==E)return D.WasServiceDown?(f.ULS.sendTraceTag(51663971,378,50,"Failed to retrieve policy data"),
{returnValue:!1,state:2}):"false"===E.toLowerCase()?(f.ULS.sendTraceTag(51664E3,378,50,"SafeLinks disabled for the user"),{returnValue:!1,state:1}):{returnValue:I.PFd(E),state:G};if(this.gUb)return G=3,f.ULS.sendTraceTag(595079384,378,50,"Currently getting SafeLinks policy"),{returnValue:!1,state:G};if(this.RDa>=this.EVb||this.SDa>=this.FVb)return G=2,f.ULS.sendTraceTag(51664001,378,50,"Exhausted all retries- Failure in GetPolicy for SafeLinks ({0}/{1} boot, {2}/{3} onClick)",this.RDa,this.EVb,this.SDa,
this.FVb),{returnValue:!1,state:G};f.ULS.sendTraceTag(23900182,378,10,"Inconsistent SafeLinks state: SafeLinks cache data is null with no on boot request pending, and {0} retries left over. Perhaps LocalStorage is inaccessable.",this.EVb+this.FVb-(this.RDa+this.SDa));return{returnValue:!0,state:G}}a6e(){const G=this.g4a();return G?G.PolicyCookie:""}T6h(){const G=this.g4a();return G?G.WebAffinitizedUrl:""}yOh(){const G=this.g4a();return G?G.AffinitizedUrl:""}JUh(){const G=new Date;try{const D=this.g4a();
G.setTime(D?D.PolicyCookieTTL:0)}catch(D){f.ULS.sendTraceTag(24462658,378,10,"Exception occured while fetching expiration time from cache: {0}",D)}return G}csd(){const G=this.JUh();return!!G&&G.getTime()<Date.now()}g4a(){if(!this.JXb){const G=u.a.instance.getItem(this.userId);if(!G||""===G)return null;this.JXb=JSON.parse(G)}return this.JXb}$3f(G){if(void 0===G||null===G)throw Error.argumentNull("safeLinksData");if(void 0===G.IsSafeLinksEnabled||null===G.IsSafeLinksEnabled||0>=G.IsSafeLinksEnabled.length)throw Error.argumentNull("safeLinksData.IsSafeLinksEnabled");
this.JXb=G;G.WasServiceDown||this.B7j(G)}B7j(G){G=JSON.stringify(G);u.a.instance.setItem(this.userId,G)}u5c(G){return void 0!==I.rh&&null!==I.rh?I.rh.Gc("WebServiceCall",G):null}WAc(G){if(void 0!==G&&null!==G){const D=G.Bc;G.stop();return{returnValue:D,stopwatch:null}}return{returnValue:null,stopwatch:G}}static PFd(G){return"false"!==G.toLowerCase()?!0:!1}}I.rh=null;I.ESc=null;Object(r.a)(I,"SafeLinksManager",null,[671]);const U=G=>{switch(G){case 3:return"Word";case 2:return"PowerPoint";case 1:return"Excel";
default:return"Unknown"}},S=G=>{switch(G){case 1:return"Edit";case 2:return"View";case 3:return"InstantView";default:return"Unknown"}};Type.registerNamespace("_Ewa");Type.registerNamespace("Common.App.SafeLinks");(()=>{Object(b.b)(c.l,{f_:"singleton"})(()=>new I(e.AFrameworkApplication.fa,e.AFrameworkApplication.Bd,String.format("{0}-{1}",U(e.AFrameworkApplication.sa.Qa.Oj),S(e.AFrameworkApplication.sa.Qa.sca))))})()}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaDSEsNext.safelinks.js.map/1de26de4bdfc72d402c5fa0ad7aa2953/EwaDSEsNext.safelinks.js.map